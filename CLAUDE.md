# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> `CLAUDE.md` and `AGENTS.md` are autogenerated by `/Init` (`forge-init.sh`). Do not edit directly — run `/Update` (`forge-update.sh`) to regenerate.

## What This Is

Session lifecycle module for the forge ecosystem. Surfaces actionable items at session start (stale ideas, captured tabs, backlog) and enforces memory capture at session end (blocks exit if insights go uncaptured). Rust crate with a path dependency on `forge-core` (`../../Core`).

## Build & Test

```bash
cargo build --release                                   # build all 3 binaries
cargo test                                              # all tests (~50)
cargo test -- test_name                                 # single test
cargo clippy -- -D warnings                             # lint (pedantic enabled)
cargo fmt --check                                       # format check
```

Binaries output to `target/release/{surface,insight,reflect}`. Hook scripts use lazy compilation via `bin/_build.sh` — binaries are built on first invocation if missing.

## Architecture

Three binaries, one library crate. Binaries are thin — they call library functions and format output.

```
src/lib.rs          → HookInput struct, read_hook_input(), in_data_dir() scope check
src/config/         → Config loading: YAML deserialization, apply_shared() overlay, path resolution
src/surface/        → Pure parsing: backlog, reminders, ideas, tabs, journal gaps (no I/O)
src/transcript/     → JSONL transcript analysis: count messages, tool turns, memory writes, insights
src/prompt/         → Pattern file loading with frontmatter/H1 stripping
src/bin/surface.rs  → SessionStart digest (ideas + rediscovery pool)
src/bin/insight.rs  → Stop hook: hard rule — blocks if ★ Insight blocks lack corresponding files
src/bin/reflect.rs  → Stop hook: soft heuristic — blocks if substantial session has no memory writes
                      Also handles PreCompact (injects reflection prompt)
```

### Hook Chain (Stop event)

`stop.sh` chains two binaries sequentially: `insight` (hard rule, always applies) → `reflect` (soft heuristic, only if insight passes). Both read the same JSON payload from stdin. First to produce stdout JSON wins.

### Hook Contract

All binaries always exit 0. Communication is via stdout JSON:
- Empty stdout = allow
- `{"decision":"block","reason":"..."}` = block (Stop)
- `{"additionalContext":"..."}` = inject (PreCompact)

Errors go to stderr via `eprintln!`.

### Config Precedence

`config.yaml` (gitignored user override) > `defaults.yaml shared:` (project-level) > compiled `Default` impl. The `apply_shared()` method overlays project-level shared paths onto any field still at its compiled default — a `config.yaml` override always wins.

### Scope Guard

`insight` and `reflect` only enforce within `$HOME/Data/` (configurable via `data_dir_suffix`). The `surface` binary runs everywhere. `reflect` in PreCompact mode also runs everywhere.

## Key Conventions

- **Module pattern**: `mod.rs` + sibling `tests.rs` in each subdirectory. Tests use `use super::*;`.
- **No error crates**: No `anyhow`/`thiserror`. Use `Option<T>` with `.ok()?` chaining. Never panic in binaries.
- **`unsafe` is forbidden**: `unsafe_code = "forbid"` in Cargo.toml.
- **Clippy pedantic** is on: `all` + `pedantic` at warn. Four allowed: `module_name_repetitions`, `must_use_candidate`, `missing_errors_doc`, `missing_panics_doc`.
- **String params**: Always `&str`. Struct fields: owned `String`. Returns: `Option<String>`.
- **Surface functions are pure**: They take string content, return `Option<String>`. No I/O — the binary handles file reads and subprocess calls.
- **Unicode escapes** for special chars: `\u{2605}` (star), `\u{2022}` (bullet), `\u{2014}` (em dash).

## Dependencies

| Crate | Purpose |
|-------|---------|
| `forge-core` | Path dep (`../../Core`) — YAML loading, `user_root()`, `ProjectConfig`, `apply_if_default()` |
| `chrono` | Date parsing and arithmetic |
| `regex` | Backlog/tab/journal line parsing |
| `serde` + `serde_json` | Config deserialization, transcript/hook JSON parsing |

Dev: `serde_yaml`, `tempfile`, `assert_cmd`, `predicates`.
