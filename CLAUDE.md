# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
OpenCode also reads this file via its Claude Code compatibility layer.

> `CLAUDE.md` and `AGENTS.md` are autogenerated by `/Init` (`forge-init.sh`). Do not edit directly — run `/Update` (`forge-update.sh`) to regenerate.

## What This Is

Session lifecycle module for the forge ecosystem. Surfaces actionable items at session start (stale ideas, captured tabs, backlog) and enforces memory capture at session end (blocks exit if insights go uncaptured). Rust crate using `forge-lib` for config loading.

Works in Claude Code (native hooks), OpenCode (TypeScript plugin adapter at `.opencode/plugins/forge-reflect.ts`), and standalone CLI.

## Build & Test

```bash
cargo build --release                                   # build all 3 binaries
cargo test                                              # all tests (58)
cargo test -- test_name                                 # single test
cargo clippy -- -D warnings                             # lint (pedantic enabled)
cargo fmt --check                                       # format check
```

Binaries output to `target/release/{surface,insight,reflect}`. Hook scripts use lazy compilation via `bin/_build.sh` — binaries are built on first invocation if missing.

## Architecture

Three binaries, one library crate. Binaries are thin — they call library functions and format output.

```
src/lib.rs          → HookInput struct, read_hook_input(), in_data_dir() scope check
src/config/         → Config loading: YAML deserialization via forge-lib deep merge, path resolution
src/surface/        → Pure parsing: backlog, reminders, ideas, tabs, journal gaps (no I/O)
src/transcript/     → JSONL transcript analysis: count messages, tool turns, memory writes, insights
src/prompt/         → Pattern file loading with frontmatter/H1 stripping
src/bin/surface.rs  → PostToolUse digest (ideas + rediscovery pool, via dispatch)
src/bin/insight.rs  → Stop hook: hard rule — blocks if ★ Insight blocks lack corresponding files
src/bin/reflect.rs  → Stop hook: soft heuristic — blocks if substantial session has no memory writes
                      Also handles PreCompact (injects reflection prompt)
```

### Hook Chain (Stop event)

`stop.sh` chains two binaries sequentially: `insight` (hard rule, always applies) → `reflect` (soft heuristic, only if insight passes). Both read the same JSON payload from stdin. First to produce stdout JSON wins.

### Hook Chain (PostToolUse event)

`PostToolUse.sh` is a one-shot hook: on the first forge-journals skill invocation per session, it runs the `surface` binary and returns `{"hookSpecificOutput":{"additionalContext":"..."}}` for AI context injection with a configurable prompt. A PPID-scoped guard file (`/tmp/forge-surface-shown-$PPID`) prevents repeat firing. Skill filtering (case match on `tool_input.skill`) ensures it only fires for journals skills.

### Hook Contract

All binaries always exit 0. Communication is via stdout JSON:
- Empty stdout = allow
- `{"decision":"block","reason":"..."}` = block (Stop)
- `{"additionalContext":"..."}` = inject (PreCompact)
- `{"hookSpecificOutput":{"additionalContext":"..."}}` = AI context injection (PostToolUse)

Errors go to stderr via `eprintln!`.

### Config Precedence

`config.yaml` (gitignored user override) > module `defaults.yaml` > compiled `Default` impl. Config loaded via forge-lib deep merge (`load_yaml_file` + `merge_values`). The `user.root` field resolves relative paths against `$HOME` at load time.

### Module Root Discovery

`Config::load()` checks env vars in order: `FORGE_MODULE_ROOT` (tool-agnostic) → `CLAUDE_PLUGIN_ROOT` (Claude Code) → compiled defaults. Hook scripts use the same chain with self-discovery as the final fallback.

### Scope Guard

`insight` and `reflect` only enforce within `$HOME/Data/` (configurable via `data_dir_suffix`). The `surface` binary runs everywhere. `reflect` in PreCompact mode also runs everywhere.

## Key Conventions

- **Module pattern**: `mod.rs` + sibling `tests.rs` in each subdirectory. Tests use `use super::*;`.
- **No error crates**: No `anyhow`/`thiserror`. Use `Option<T>` with `.ok()?` chaining. Never panic in binaries.
- **`unsafe` is forbidden**: `unsafe_code = "forbid"` in Cargo.toml.
- **Clippy pedantic** is on: `all` + `pedantic` at warn. Four allowed: `module_name_repetitions`, `must_use_candidate`, `missing_errors_doc`, `missing_panics_doc`.
- **String params**: Always `&str`. Struct fields: owned `String`. Returns: `Option<String>`.
- **String building**: Use `writeln!()` (via `use std::fmt::Write`) instead of `push_str(&format!(...))`.
- **Surface functions are pure**: They take string content, return `Option<String>`. No I/O — the binary handles file reads and subprocess calls.
- **Unicode escapes** for special chars: `\u{2605}` (star), `\u{2022}` (bullet), `\u{2014}` (em dash).

## Dependencies

| Crate | Purpose |
|-------|---------|
| `forge-lib` | Path dep (`lib/`) — `load_yaml_file()`, `merge_values()` for config deep merge |
| `chrono` | Date parsing and arithmetic |
| `regex` | Backlog/tab/journal line parsing |
| `serde` + `serde_json` | Config deserialization, transcript/hook JSON parsing |
| `serde_yaml` | YAML config deserialization |

Dev: `tempfile`, `assert_cmd`, `predicates`.
